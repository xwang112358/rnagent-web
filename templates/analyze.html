<html>
    <head>
        <!-- Load Plotly JS from CDN -->
        <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
        <!-- Load 3Dmol.js from CDN -->
        <script src="https://3Dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
        <style>
            .loading {
                display: inline-block;
                padding: 10px 20px;
                background-color: #f0f0f0;
                border-radius: 4px;
                margin: 10px 0;
            }
            .error {
                color: #d32f2f;
                padding: 10px;
                background-color: #ffebee;
                border-left: 4px solid #d32f2f;
                margin: 10px 0;
            }
            .visualization-container {
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                align-items: flex-start;
            }
            .plot-area {
                flex: 1;
                min-width: 600px;
                /* width: 600px; */
            }
            .info-panel {
                width: 420px;
                background: #f8f9fa;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 15px;
                position: sticky;
                top: 20px;
                min-height: 300px;
            }
            .info-placeholder {
                color: #666;
                text-align: center;
                padding-top: 100px;
                font-style: italic;
            }
            .molecule-detail {
                display: none;
            }
            .molecule-detail img {
                width: 100%;
                height: auto;
                border: 1px solid #eee;
                background: white;
                border-radius: 4px;
                margin: 10px 0;
            }
            .molecule-detail .name {
                font-weight: bold;
                font-size: 16px;
                margin-bottom: 10px;
                color: #2196F3;
                word-break: break-word;
            }
            .molecule-detail .property {
                margin-bottom: 8px;
                font-size: 13px;
            }
            .molecule-detail .label {
                font-weight: bold;
                color: #555;
            }
            .molecule-detail .smiles {
                font-family: monospace;
                font-size: 11px;
                background: white;
                padding: 5px;
                border: 1px solid #eee;
                border-radius: 4px;
                word-break: break-all;
                max-height: 100px;
                overflow-y: auto;
            }
            .action-container {
                text-align: center;
                margin: 40px 0;
            }
            .action-button {
                display: inline-block;
                padding: 15px 30px;
                font-size: 18px;
                font-weight: bold;
                color: white;
                background-color: #2196F3;
                text-decoration: none;
                border-radius: 5px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                transition: background-color 0.3s;
            }
            .action-button:hover {
                background-color: #1976D2;
            }
            #pdb-viewer-container {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin: 30px 0;
                flex-wrap: wrap;
            }
            #pdb-viewer {
                width: 700px;
                height: 500px;
                position: relative;
                border: 2px solid #2196F3;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            #chatbox-container {
                width: 700px;
                height: 500px;
                border: 2px solid #2196F3;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                background: white;
                display: flex;
                flex-direction: column;
            }
            #chatbox-header {
                background: #2196F3;
                color: white;
                padding: 15px;
                font-weight: bold;
                border-radius: 6px 6px 0 0;
                font-size: 16px;
            }
            #chat-messages {
                flex: 1;
                overflow-y: auto;
                padding: 15px;
                background: #f8f9fa;
            }
            .chat-message {
                margin-bottom: 15px;
                display: flex;
                flex-direction: column;
            }
            .chat-message.user {
                align-items: flex-end;
            }
            .chat-message.assistant {
                align-items: flex-start;
            }
            .message-bubble {
                max-width: 80%;
                padding: 10px 15px;
                border-radius: 12px;
                word-wrap: break-word;
            }
            .chat-message.user .message-bubble {
                background: #2196F3;
                color: white;
                white-space: pre-wrap;
            }
            .chat-message.assistant .message-bubble {
                background: white;
                border: 1px solid #ddd;
                color: #333;
                white-space: normal;
            }
            .message-bubble h1,
            .message-bubble h2,
            .message-bubble h3,
            .message-bubble h4,
            .message-bubble h5,
            .message-bubble h6 {
                margin: 12px 0 8px 0;
                font-weight: bold;
                color: #2196F3;
                line-height: 1.3;
            }
            .message-bubble h1 { font-size: 1.5em; }
            .message-bubble h2 { font-size: 1.3em; }
            .message-bubble h3 { font-size: 1.15em; }
            .message-bubble h4 { font-size: 1.05em; }
            .message-bubble h5 { font-size: 1em; }
            .message-bubble h6 { font-size: 0.95em; }
            .message-bubble h1:first-child,
            .message-bubble h2:first-child,
            .message-bubble h3:first-child,
            .message-bubble h4:first-child,
            .message-bubble h5:first-child,
            .message-bubble h6:first-child {
                margin-top: 0;
            }
            .message-bubble ul {
                margin: 8px 0;
                padding-left: 20px;
                list-style-type: disc;
            }
            .message-bubble li {
                margin: 4px 0;
                line-height: 1.4;
            }
            .message-bubble ul:first-child {
                margin-top: 0;
            }
            .message-bubble ul:last-child {
                margin-bottom: 0;
            }
            .message-label {
                font-size: 11px;
                color: #666;
                margin-bottom: 4px;
                font-weight: bold;
            }
            #chat-input-container {
                display: flex;
                gap: 10px;
                padding: 15px;
                border-top: 1px solid #ddd;
                background: white;
                border-radius: 0 0 6px 6px;
            }
            #chat-input {
                flex: 1;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 14px;
                font-family: inherit;
            }
            #chat-input:focus {
                outline: none;
                border-color: #2196F3;
                box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            }
            #chat-send-btn {
                padding: 10px 20px;
                background: #2196F3;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
                font-size: 14px;
                transition: background 0.3s;
            }
            #chat-send-btn:hover:not(:disabled) {
                background: #1976D2;
            }
            #chat-send-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
            .chat-loading {
                text-align: center;
                color: #666;
                font-style: italic;
                padding: 10px;
            }
            .chat-error {
                background: #ffebee;
                color: #d32f2f;
                padding: 10px;
                border-radius: 5px;
                margin: 10px 0;
                border-left: 4px solid #d32f2f;
            }
            .cluster-button:hover {
                opacity: 0.85;
            }
            .cluster-button:active {
                transform: scale(0.98);
            }
            .cluster-button:disabled {
                background-color: #cccccc;
                cursor: not-allowed;
                opacity: 0.6;
            }
            #n-clusters-input:focus {
                outline: none;
                border-color: #2196F3;
                box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            }
            #n-clusters-input:disabled {
                background-color: #f0f0f0;
                cursor: not-allowed;
            }
        </style>
    </head>
    <body>
        <h1>Analysis Results</h1>

        <h2>Understanding the RNA Target</h2>
        
        <div style="background-color: #e8f4f8; padding: 1em; margin: 1em 0; border-left: 4px solid #2196F3; max-width: 1440px; margin-left: auto; margin-right: auto;">
            <strong>RNA Target:</strong> {{ target }}<br>
            <strong>PDB ID:</strong> {{ pdb_id }}<br>
            <strong>PDB Title:</strong> {{ pdb_title }}
        </div>
        
        <div id="pdb-viewer-container">
            <div id="pdb-viewer"></div>
            
            <div id="chatbox-container">
                <div id="chatbox-header">
                    ðŸ’¬ RNA Structure Assistant
                </div>
                <div id="chat-messages">
                    {% if chat_intro %}
                    <div class="chat-message assistant">
                        <div class="message-label">Assistant</div>
                        <div class="message-bubble" id="initial-message">{{ chat_intro }}</div>
                    </div>
                    {% else %}
                    <div class="chat-loading">Loading assistant...</div>
                    {% endif %}
                </div>
                <div id="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Ask a question about this RNA structure..." />
                    <button id="chat-send-btn">Send</button>
                </div>
            </div>
        </div>
        
        {% if analysis %}
        <div style="background-color: lightgray; padding: 1em; margin: 1em 0;">
            {{ analysis|safe }}
        </div>
        {% endif %}
        
        <!-- <h2>Evaluate RNAmigo2</h2>
        <p>A structure-based deep learning virtual screening pipeline for RNA targets</p> -->
        
        <h2>Analyze Active Hits</h2>
        <p style="font-size: 20px; font-weight: bold; margin: 15px 0;">Number of active molecules: <span id="active-count">{{ num_hits }}</span></p>
        
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 10px 0; color: #333; font-size: 16px;">Filter by QED and SA Scores</h4>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                <div style="display: flex; gap: 5px; align-items: center;">
                    <label for="qed-min" style="font-weight: bold; color: #333; font-size: 14px; min-width: 70px;">QED Min:</label>
                    <input 
                        type="number" 
                        id="qed-min" 
                        step="0.001" 
                        min="0" 
                        max="1"
                        style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; width: 100px; transition: border-color 0.3s;"
                    />
                </div>
                <div style="display: flex; gap: 5px; align-items: center;">
                    <label for="qed-max" style="font-weight: bold; color: #333; font-size: 14px; min-width: 70px;">QED Max:</label>
                    <input 
                        type="number" 
                        id="qed-max" 
                        step="0.001" 
                        min="0" 
                        max="1"
                        style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; width: 100px; transition: border-color 0.3s;"
                    />
                </div>
                <div style="display: flex; gap: 5px; align-items: center;">
                    <label for="sa-min" style="font-weight: bold; color: #333; font-size: 14px; min-width: 70px;">SA Min:</label>
                    <input 
                        type="number" 
                        id="sa-min" 
                        step="0.1" 
                        min="1" 
                        max="10"
                        style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; width: 100px; transition: border-color 0.3s;"
                    />
                </div>
                <div style="display: flex; gap: 5px; align-items: center;">
                    <label for="sa-max" style="font-weight: bold; color: #333; font-size: 14px; min-width: 70px;">SA Max:</label>
                    <input 
                        type="number" 
                        id="sa-max" 
                        step="0.1" 
                        min="1" 
                        max="10"
                        style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; width: 100px; transition: border-color 0.3s;"
                    />
                </div>
            </div>
        </div>
        
        <div id="active-molecules-list" style="background-color: #f0f0f0; padding: 1em; margin: 1em 0; font-family: monospace; max-height: 300px; overflow-y: auto; border: 1px solid #ccc;">
            {{ examples|safe }}
        </div>
        
        <h3 style="margin-top: 50px;">Molecular Property Distributions</h3>
        <p style="color: #666; font-size: 14px; margin: 10px 0;">
            <strong>Property Analysis:</strong> Compare the distribution of drug-likeness (QED) and synthetic accessibility (SA Score) between all molecules in the dataset and the positive hits for {{ target }}.
        </p>
        
        <div id="density-loading" class="loading">Loading property distributions...</div>
        <div id="density-error" class="error" style="display: none;"></div>
        
        <div style="display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 400px;">
                <div id="density-qed" style="width: 100%; height: 500px;"></div>
            </div>
            <div style="flex: 1; min-width: 400px;">
                <div id="density-sa" style="width: 100%; height: 500px;"></div>
            </div>
        </div>
        
        <h3>Chemical Space Visualization (UMAP)</h3>
        <p style="color: #666; font-size: 14px; margin: 10px 0;">
            <strong>âœ¨ Interactive Features:</strong> Hover over any point to see the molecule information in the panel to the right. Click and drag to pan, scroll to zoom.
        </p>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 10px 0; color: #333; font-size: 16px;">K-Means Clustering</h4>
            <p style="margin: 0 0 10px 0; color: #666; font-size: 13px;">
                Cluster molecules based on their chemical fingerprints to identify similar chemical groups:
            </p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <label for="n-clusters-input" style="font-weight: bold; color: #333; font-size: 14px;">
                    Number of clusters:
                </label>
                <input 
                    type="number" 
                    id="n-clusters-input" 
                    min="2" 
                    max="50" 
                    value="5" 
                    style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; width: 80px; transition: border-color 0.3s;"
                    onkeypress="if(event.key === 'Enter') performKMeansFromInput()"
                />
                <button id="cluster-button" class="cluster-button" onclick="performKMeansFromInput()" style="padding: 10px 20px; background-color: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; transition: background-color 0.3s;">
                    Apply Clustering
                </button>
                <button id="reset-colors" class="cluster-button" onclick="resetColors()" style="padding: 10px 20px; background-color: #757575; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; transition: background-color 0.3s;">
                    Reset Colors
                </button>
            </div>
            <div id="cluster-status" style="margin-top: 10px; font-size: 13px; color: #666;"></div>
        </div>
        
        <div id="loading" class="loading">Loading UMAP visualization with molecule structures... This may take a few moments.</div>
        <div id="error-message" class="error" style="display: none;"></div>
        
        <div class="visualization-container">
            <div class="plot-area">
                <div id="umap-plot" style="width: 100%; height: 600px;"></div>
            </div>
            <div class="info-panel">
                <div id="info-placeholder" class="info-placeholder">
                    Hover over a point on the plot<br>to see molecule details
                </div>
                <div id="molecule-detail" class="molecule-detail">
                    <div id="mol-name" class="name"></div>
                    <img id="mol-img" src="" alt="Molecule Structure">
                    <div class="property">
                        <span class="label">Coordinates:</span><br>
                        UMAP-1: <span id="mol-x"></span><br>
                        UMAP-2: <span id="mol-y"></span>
                    </div>
                    <div class="property">
                        <span class="label">SMILES:</span>
                        <div id="mol-smiles" class="smiles"></div>
                    </div>
                    <div class="property">
                        <span class="label">QED (Drug-likeness):</span>
                        <span id="mol-qed"></span>
                    </div>
                    <div class="property">
                        <span class="label">SA Score (Synthetic Accessibility):</span>
                        <span id="mol-sa"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            let moleculeData = null;
            let originalPlotData = null;
            let currentClusterLabels = null;
            const detailPanel = document.getElementById('molecule-detail');
            const placeholder = document.getElementById('info-placeholder');
            
            // UI Elements
            const molName = document.getElementById('mol-name');
            const molImg = document.getElementById('mol-img');
            const molX = document.getElementById('mol-x');
            const molY = document.getElementById('mol-y');
            const molSmiles = document.getElementById('mol-smiles');
            const molQed = document.getElementById('mol-qed');
            const molSa = document.getElementById('mol-sa');
            
            // Active molecules filtering
            let activeMoleculesData = null;
            const activeMoleculesList = document.getElementById('active-molecules-list');
            const activeCountSpan = document.getElementById('active-count');
            const qedMinInput = document.getElementById('qed-min');
            const qedMaxInput = document.getElementById('qed-max');
            const saMinInput = document.getElementById('sa-min');
            const saMaxInput = document.getElementById('sa-max');
            
            // Fetch active molecules data and initialize filters
            function initializeActiveMoleculesFilter() {
                fetch('/active_molecules_data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: 'target={{ target }}'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || 'Failed to load active molecules data');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    activeMoleculesData = data.molecules;
                    
                    // Initialize input fields with min/max values
                    qedMinInput.value = data.qed_min.toFixed(3);
                    qedMaxInput.value = data.qed_max.toFixed(3);
                    qedMinInput.min = data.qed_min.toFixed(3);
                    qedMaxInput.max = data.qed_max.toFixed(3);
                    
                    saMinInput.value = data.sa_min.toFixed(1);
                    saMaxInput.value = data.sa_max.toFixed(1);
                    saMinInput.min = data.sa_min.toFixed(1);
                    saMaxInput.max = data.sa_max.toFixed(1);
                    
                    // Initial filter to show all molecules
                    filterMolecules();
                })
                .catch(error => {
                    console.error('Error loading active molecules data:', error);
                    activeMoleculesList.innerHTML = `<div style="color: #d32f2f;">Error loading molecule data: ${error.message}</div>`;
                });
            }
            
            // Filter molecules based on QED and SA score ranges
            function filterMolecules() {
                if (!activeMoleculesData) {
                    return;
                }
                
                // Get filter values
                const qedMin = parseFloat(qedMinInput.value) || 0;
                const qedMax = parseFloat(qedMaxInput.value) || 1;
                const saMin = parseFloat(saMinInput.value) || 1;
                const saMax = parseFloat(saMaxInput.value) || 10;
                
                // Validate ranges
                if (qedMin > qedMax) {
                    activeMoleculesList.innerHTML = '<div style="color: #d32f2f;">Error: QED Min cannot be greater than QED Max</div>';
                    return;
                }
                
                if (saMin > saMax) {
                    activeMoleculesList.innerHTML = '<div style="color: #d32f2f;">Error: SA Min cannot be greater than SA Max</div>';
                    return;
                }
                
                // Filter molecules
                const filtered = activeMoleculesData.filter(mol => {
                    const qed = mol.qed;
                    const sa = mol.sa;
                    return qed >= qedMin && qed <= qedMax && sa >= saMin && sa <= saMax;
                });
                
                // Update count
                activeCountSpan.textContent = filtered.length;
                
                // Update display
                if (filtered.length === 0) {
                    activeMoleculesList.innerHTML = '<div style="color: #666; font-style: italic;">No molecules match the selected filters.</div>';
                } else {
                    // Create table header
                    let html = '<table style="width: 100%; border-collapse: collapse;">';
                    html += '<thead><tr style="border-bottom: 2px solid #ccc; font-weight: bold; background-color: #e0e0e0;">';
                    html += '<th style="text-align: left; padding: 8px;">SMILES</th>';
                    html += '<th style="text-align: left; padding: 8px;">QED</th>';
                    html += '<th style="text-align: left; padding: 8px;">SA Score</th>';
                    html += '</tr></thead><tbody>';
                    
                    // Add rows for each molecule
                    filtered.forEach(mol => {
                        html += '<tr style="border-bottom: 1px solid #e0e0e0;">';
                        html += `<td style="padding: 6px 8px; word-break: break-all;">${mol.smiles}</td>`;
                        html += `<td style="padding: 6px 8px;">${mol.qed.toFixed(3)}</td>`;
                        html += `<td style="padding: 6px 8px;">${mol.sa.toFixed(2)}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    activeMoleculesList.innerHTML = html;
                }
            }
            
            // Add event listeners to input fields
            qedMinInput.addEventListener('input', filterMolecules);
            qedMaxInput.addEventListener('input', filterMolecules);
            saMinInput.addEventListener('input', filterMolecules);
            saMaxInput.addEventListener('input', filterMolecules);
            
            // Initialize on page load
            initializeActiveMoleculesFilter();
            
            // Fetch UMAP plot components (Plotly)
            fetch('/umap_plot', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'target={{ target }}'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Failed to generate UMAP');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Hide loading message
                document.getElementById('loading').style.display = 'none';
                
                // Store molecule data
                moleculeData = {
                    images: data.images,
                    names: data.names,
                    smiles: data.smiles,
                    qed: data.qed,
                    sa: data.sa,
                    // Extract coordinates from plot data for easy access
                    x: data.plot_data.data[0].x,
                    y: data.plot_data.data[0].y
                };
                
                // Create the Plotly plot using the JSON data
                const plotDiv = document.getElementById('umap-plot');
                
                // Adjust layout for embedded view
                const layout = data.plot_data.layout;
                layout.width = null; // Let it be responsive
                layout.height = 600;
                layout.margin = {l: 50, r: 20, t: 50, b: 50};
                
                Plotly.newPlot('umap-plot', data.plot_data.data, layout, {
                    displayModeBar: true, 
                    displaylogo: false,
                    responsive: true
                });
                
                // Save original plot data for reset functionality
                originalPlotData = JSON.parse(JSON.stringify(data.plot_data.data[0]));
                
                // Add event listener for hover to show molecule structure
                plotDiv.on('plotly_hover', function(eventData) {
                    const pointIndex = eventData.points[0].pointIndex;
                    
                    // Update details
                    molName.textContent = moleculeData.names[pointIndex];
                    molImg.src = moleculeData.images[pointIndex];
                    molX.textContent = moleculeData.x[pointIndex].toFixed(2);
                    molY.textContent = moleculeData.y[pointIndex].toFixed(2);
                    molSmiles.textContent = moleculeData.smiles[pointIndex];
                    
                    // Update QED and SA scores
                    if (moleculeData.qed[pointIndex] !== null) {
                        molQed.textContent = moleculeData.qed[pointIndex].toFixed(3);
                    } else {
                        molQed.textContent = 'N/A';
                    }
                    
                    if (moleculeData.sa[pointIndex] !== null) {
                        molSa.textContent = moleculeData.sa[pointIndex].toFixed(2);
                    } else {
                        molSa.textContent = 'N/A';
                    }
                    
                    // Show details, hide placeholder
                    placeholder.style.display = 'none';
                    detailPanel.style.display = 'block';
                });
                
                // Optional: Clear on unhover, or keep last selected
                // plotDiv.on('plotly_unhover', function() {
                //    placeholder.style.display = 'block';
                //    detailPanel.style.display = 'none';
                // });
            })
            .catch(error => {
                // Hide loading message and show error
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('error-message').textContent = 'Error: ' + error.message;
                console.error('UMAP Error:', error);
            });
            
            // Fetch and render density distribution plots
            fetch('/density_plots', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'target={{ target }}'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Failed to generate density plots');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Hide loading message
                document.getElementById('density-loading').style.display = 'none';
                
                // Function to calculate KDE using Gaussian kernel
                function calculateKDE(values, bandwidth = 0.05) {
                    const min = Math.min(...values);
                    const max = Math.max(...values);
                    const nPoints = 200;
                    const x = [];
                    const y = [];
                    const step = (max - min) / nPoints;
                    
                    for (let i = 0; i <= nPoints; i++) {
                        const xi = min + i * step;
                        x.push(xi);
                        
                        // Calculate kernel density at xi
                        let density = 0;
                        for (const val of values) {
                            const u = (xi - val) / bandwidth;
                            density += Math.exp(-0.5 * u * u) / Math.sqrt(2 * Math.PI);
                        }
                        y.push(density / (values.length * bandwidth));
                    }
                    
                    return { x, y };
                }
                
                // QED Plot
                const qedHistAll = {
                    x: data.qed_all,
                    name: `All Molecules (n=${data.n_all})`,
                    type: 'histogram',
                    histnorm: 'probability density',
                    opacity: 0.6,
                    marker: {
                        color: 'rgba(128, 128, 128, 0.7)',
                        line: {
                            color: 'rgba(128, 128, 128, 1)',
                            width: 1
                        }
                    },
                    xbins: {
                        size: 0.05
                    }
                };
                
                const qedHistHits = {
                    x: data.qed_hits,
                    name: `Positive Hits (n=${data.n_hits})`,
                    type: 'histogram',
                    histnorm: 'probability density',
                    opacity: 0.6,
                    marker: {
                        color: 'rgba(33, 150, 243, 0.7)',
                        line: {
                            color: 'rgba(33, 150, 243, 1)',
                            width: 1
                        }
                    },
                    xbins: {
                        size: 0.05
                    }
                };
                
                // Calculate KDE for QED
                const kdeQedAll = calculateKDE(data.qed_all, 0.05);
                const kdeQedHits = calculateKDE(data.qed_hits, 0.05);
                
                const qedKdeAll = {
                    x: kdeQedAll.x,
                    y: kdeQedAll.y,
                    name: 'All Molecules (KDE)',
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: 'rgba(80, 80, 80, 1)',
                        width: 2
                    },
                    showlegend: false
                };
                
                const qedKdeHits = {
                    x: kdeQedHits.x,
                    y: kdeQedHits.y,
                    name: 'Positive Hits (KDE)',
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: 'rgba(21, 101, 192, 1)',
                        width: 2
                    },
                    showlegend: false
                };
                
                const qedLayout = {
                    title: {
                        text: 'QED (Drug-likeness) Distribution',
                        font: { size: 16 }
                    },
                    xaxis: {
                        title: 'QED Score',
                        range: [0, 1],
                        showgrid: true,
                        gridcolor: '#e0e0e0'
                    },
                    yaxis: {
                        title: 'Density',
                        showgrid: true,
                        gridcolor: '#e0e0e0'
                    },
                    barmode: 'overlay',
                    plot_bgcolor: '#f8f9fa',
                    paper_bgcolor: 'white',
                    showlegend: true,
                    legend: {
                        x: 0.02,
                        y: 0.98,
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#ccc',
                        borderwidth: 1
                    }
                };
                
                Plotly.newPlot('density-qed', [qedHistAll, qedHistHits, qedKdeAll, qedKdeHits], qedLayout, {
                    displayModeBar: true,
                    displaylogo: false,
                    responsive: true
                });
                
                // SA Score Plot
                const saHistAll = {
                    x: data.sa_all,
                    name: `All Molecules (n=${data.n_all})`,
                    type: 'histogram',
                    histnorm: 'probability density',
                    opacity: 0.6,
                    marker: {
                        color: 'rgba(128, 128, 128, 0.7)',
                        line: {
                            color: 'rgba(128, 128, 128, 1)',
                            width: 1
                        }
                    },
                    xbins: {
                        size: 0.3
                    }
                };
                
                const saHistHits = {
                    x: data.sa_hits,
                    name: `Positive Hits (n=${data.n_hits})`,
                    type: 'histogram',
                    histnorm: 'probability density',
                    opacity: 0.6,
                    marker: {
                        color: 'rgba(33, 150, 243, 0.7)',
                        line: {
                            color: 'rgba(33, 150, 243, 1)',
                            width: 1
                        }
                    },
                    xbins: {
                        size: 0.3
                    }
                };
                
                // Calculate KDE for SA Score
                const kdeSaAll = calculateKDE(data.sa_all, 0.3);
                const kdeSaHits = calculateKDE(data.sa_hits, 0.3);
                
                const saKdeAll = {
                    x: kdeSaAll.x,
                    y: kdeSaAll.y,
                    name: 'All Molecules (KDE)',
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: 'rgba(80, 80, 80, 1)',
                        width: 2
                    },
                    showlegend: false
                };
                
                const saKdeHits = {
                    x: kdeSaHits.x,
                    y: kdeSaHits.y,
                    name: 'Positive Hits (KDE)',
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: 'rgba(21, 101, 192, 1)',
                        width: 2
                    },
                    showlegend: false
                };
                
                const saLayout = {
                    title: {
                        text: 'SA Score (Synthetic Accessibility) Distribution',
                        font: { size: 16 }
                    },
                    xaxis: {
                        title: 'SA Score (1=easy, 10=difficult)',
                        showgrid: true,
                        gridcolor: '#e0e0e0'
                    },
                    yaxis: {
                        title: 'Density',
                        showgrid: true,
                        gridcolor: '#e0e0e0'
                    },
                    barmode: 'overlay',
                    plot_bgcolor: '#f8f9fa',
                    paper_bgcolor: 'white',
                    showlegend: true,
                    legend: {
                        x: 0.02,
                        y: 0.98,
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#ccc',
                        borderwidth: 1
                    }
                };
                
                Plotly.newPlot('density-sa', [saHistAll, saHistHits, saKdeAll, saKdeHits], saLayout, {
                    displayModeBar: true,
                    displaylogo: false,
                    responsive: true
                });
            })
            .catch(error => {
                // Hide loading message and show error
                document.getElementById('density-loading').style.display = 'none';
                document.getElementById('density-error').style.display = 'block';
                document.getElementById('density-error').textContent = 'Error: ' + error.message;
                console.error('Density Plot Error:', error);
            });
            
            // K-Means clustering function with input validation
            function performKMeansFromInput() {
                const input = document.getElementById('n-clusters-input');
                const nClusters = parseInt(input.value);
                
                // Validate input
                const validationError = validateClusterInput(nClusters);
                if (validationError) {
                    const statusDiv = document.getElementById('cluster-status');
                    statusDiv.textContent = `Error: ${validationError}`;
                    statusDiv.style.color = '#d32f2f';
                    input.style.borderColor = '#d32f2f';
                    return;
                }
                
                // Reset input border color
                input.style.borderColor = '#ddd';
                
                // Perform clustering
                performKMeans(nClusters);
            }
            
            // Validate cluster input
            function validateClusterInput(nClusters) {
                if (isNaN(nClusters)) {
                    return 'Please enter a valid number';
                }
                
                if (!Number.isInteger(nClusters)) {
                    return 'Number of clusters must be a whole number';
                }
                
                if (nClusters < 2) {
                    return 'Number of clusters must be at least 2';
                }
                
                if (nClusters > 50) {
                    return 'Number of clusters cannot exceed 50';
                }
                
                if (!moleculeData || nClusters > moleculeData.names.length) {
                    return `Number of clusters cannot exceed the number of molecules (${moleculeData ? moleculeData.names.length : 0})`;
                }
                
                return null; // No error
            }
            
            // K-Means clustering function
            function performKMeans(nClusters) {
                const statusDiv = document.getElementById('cluster-status');
                const buttons = document.querySelectorAll('.cluster-button');
                const input = document.getElementById('n-clusters-input');
                
                // Disable buttons and input during processing
                buttons.forEach(btn => btn.disabled = true);
                input.disabled = true;
                
                statusDiv.textContent = `Computing ${nClusters} clusters...`;
                statusDiv.style.color = '#2196F3';
                
                fetch('/kmeans_cluster', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `target={{ target }}&n_clusters=${nClusters}`
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || 'Failed to perform clustering');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    currentClusterLabels = data.cluster_labels;
                    
                    // Create color palette for clusters
                    const colors = generateClusterColors(nClusters);
                    
                    // Map cluster labels to colors
                    const markerColors = currentClusterLabels.map(label => colors[label]);
                    
                    // Update plot with cluster colors
                    const plotDiv = document.getElementById('umap-plot');
                    Plotly.restyle(plotDiv, {
                        'marker.color': [markerColors],
                        'marker.line.color': ['white']
                    });
                    
                    // Update plot title
                    Plotly.relayout(plotDiv, {
                        'title.text': `UMAP Visualization with ${nClusters} K-Means Clusters (${data.n_molecules} molecules)`
                    });
                    
                    // Update hover event to include cluster info
                    updateHoverWithClusters();
                    
                    statusDiv.textContent = `âœ“ Successfully created ${nClusters} clusters`;
                    statusDiv.style.color = '#4CAF50';
                    
                    // Re-enable buttons and input
                    buttons.forEach(btn => btn.disabled = false);
                    input.disabled = false;
                })
                .catch(error => {
                    statusDiv.textContent = `Error: ${error.message}`;
                    statusDiv.style.color = '#d32f2f';
                    console.error('K-Means Error:', error);
                    
                    // Re-enable buttons and input
                    buttons.forEach(btn => btn.disabled = false);
                    input.disabled = false;
                });
            }
            
            // Reset to original colors
            function resetColors() {
                const statusDiv = document.getElementById('cluster-status');
                const plotDiv = document.getElementById('umap-plot');
                const input = document.getElementById('n-clusters-input');
                
                if (!originalPlotData) {
                    statusDiv.textContent = 'No original data to reset to';
                    statusDiv.style.color = '#d32f2f';
                    return;
                }
                
                // Reset to original colors
                Plotly.restyle(plotDiv, {
                    'marker.color': [originalPlotData.marker.color],
                    'marker.line.color': ['white']
                });
                
                // Reset title
                Plotly.relayout(plotDiv, {
                    'title.text': `UMAP Visualization of Active Molecules for {{ target }} (${moleculeData.names.length} molecules)`
                });
                
                // Reset input border color
                input.style.borderColor = '#ddd';
                
                currentClusterLabels = null;
                statusDiv.textContent = 'Reset to original visualization';
                statusDiv.style.color = '#666';
            }
            
            // Generate distinct colors for clusters
            function generateClusterColors(nClusters) {
                // Base color palette for up to 20 clusters
                const baseColors = [
                    '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
                    '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf',
                    '#aec7e8', '#ffbb78', '#98df8a', '#ff9896', '#c5b0d5',
                    '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6'
                ];
                
                // If we need more colors than in the base palette, generate them using HSL
                if (nClusters <= baseColors.length) {
                    return baseColors.slice(0, nClusters);
                }
                
                // Generate additional colors using evenly spaced hues
                const colors = [...baseColors];
                for (let i = baseColors.length; i < nClusters; i++) {
                    const hue = (i * 360 / nClusters) % 360;
                    const saturation = 65 + (i % 3) * 10; // Vary saturation slightly
                    const lightness = 50 + (i % 2) * 10;  // Vary lightness slightly
                    colors.push(`hsl(${hue}, ${saturation}%, ${lightness}%)`);
                }
                
                return colors;
            }
            
            // Update hover to include cluster information
            function updateHoverWithClusters() {
                const plotDiv = document.getElementById('umap-plot');
                
                plotDiv.on('plotly_hover', function(eventData) {
                    const pointIndex = eventData.points[0].pointIndex;
                    
                    // Update details
                    molName.textContent = moleculeData.names[pointIndex];
                    molImg.src = moleculeData.images[pointIndex];
                    molX.textContent = moleculeData.x[pointIndex].toFixed(2);
                    molY.textContent = moleculeData.y[pointIndex].toFixed(2);
                    molSmiles.textContent = moleculeData.smiles[pointIndex];
                    
                    // Update QED and SA scores
                    if (moleculeData.qed[pointIndex] !== null) {
                        molQed.textContent = moleculeData.qed[pointIndex].toFixed(3);
                    } else {
                        molQed.textContent = 'N/A';
                    }
                    
                    if (moleculeData.sa[pointIndex] !== null) {
                        molSa.textContent = moleculeData.sa[pointIndex].toFixed(2);
                    } else {
                        molSa.textContent = 'N/A';
                    }
                    
                    // Show details, hide placeholder
                    placeholder.style.display = 'none';
                    detailPanel.style.display = 'block';
                });
            }
        </script>
        
        <script>
            // Initialize 3Dmol.js viewer for PDB structure
            let pdbViewer;
            
            function initPDBViewer() {
                pdbViewer = $3Dmol.createViewer("pdb-viewer", {
                    backgroundColor: "white",
                    ui: true  // Enable UI controls
                });
            }
            
            function loadPDBStructure() {
                const pdbId = "{{ pdb_id }}";
                
                if (!pdbId) return;
                
                // Clear previous structure
                pdbViewer.clear();
                
                // Load from RCSB by PDB ID
                $3Dmol.download(`pdb:${pdbId}`, pdbViewer, {}, function () {
                    // Add a cartoon representation with spectrum coloring
                    pdbViewer.setStyle({}, { cartoon: { color: "spectrum" } });
                    
                    // Zoom to fit the structure
                    pdbViewer.zoomTo();
                    
                    // Enable spinning animation around y-axis at speed 2
                    pdbViewer.spin('y', 2);
                    
                    pdbViewer.render();
                });
            }
            
            // Initialize and load PDB structure when page loads
            window.addEventListener('DOMContentLoaded', function() {
                initPDBViewer();
                loadPDBStructure();
            });
        </script>
        
        <script>
            // Chatbox functionality
            let conversationHistory = [];
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            
            // Auto-scroll chat to bottom
            function scrollChatToBottom() {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Convert markdown to HTML (support for headers, bold, italic, lists, and line breaks)
            function markdownToHtml(text) {
                // First escape HTML to prevent XSS
                const escapeHtml = (str) => {
                    const div = document.createElement('div');
                    div.textContent = str;
                    return div.innerHTML;
                };
                
                let html = escapeHtml(text);
                
                // Split into lines to process headers and lists (which are line-based)
                const lines = html.split('\n');
                const processedLines = [];
                let inList = false;
                let listItems = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Check for markdown headers (# Header)
                    const headerMatch = line.match(/^(#{1,6})\s+(.+)$/);
                    if (headerMatch) {
                        // Close any open list before header
                        if (inList) {
                            processedLines.push('<ul>' + listItems.join('') + '</ul>');
                            listItems = [];
                            inList = false;
                        }
                        const level = headerMatch[1].length;
                        const headerText = headerMatch[2].trim();
                        processedLines.push(`<h${level}>${headerText}</h${level}>`);
                        continue;
                    }
                    
                    // Check for bullet points (- or * followed by space)
                    const bulletMatch = line.match(/^[-*]\s+(.+)$/);
                    if (bulletMatch) {
                        let itemText = bulletMatch[1].trim();
                        // Process markdown inside list items (bold, italic)
                        itemText = itemText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                        itemText = itemText.replace(/\*([^*\n<>]+?)\*/g, '<em>$1</em>');
                        listItems.push('<li>' + itemText + '</li>');
                        inList = true;
                        continue;
                    }
                    
                    // Not a bullet point - close list if we were in one
                    if (inList) {
                        processedLines.push('<ul>' + listItems.join('') + '</ul>');
                        listItems = [];
                        inList = false;
                    }
                    
                    // Regular line
                    processedLines.push(line);
                }
                
                // Close any remaining open list
                if (inList) {
                    processedLines.push('<ul>' + listItems.join('') + '</ul>');
                }
                
                html = processedLines.join('\n');
                
                // Convert **bold** to <strong>bold</strong>
                // Process bold first to avoid conflicts with italic
                html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                
                // Convert *italic* to <em>italic</em>
                // Process italic after bold - any remaining single asterisks are italic
                // Match *text* where text doesn't contain asterisks
                html = html.replace(/\*([^*\n<>]+?)\*/g, '<em>$1</em>');
                
                // Convert line breaks to <br> (but not inside lists or headers)
                // We'll replace \n with <br> but need to be careful about lists
                // Simple approach: replace \n with <br>, then clean up list formatting
                html = html.replace(/\n/g, '<br>');
                // Remove <br> tags that appear right after </li> or before <li>
                html = html.replace(/<\/li><br>/g, '</li>');
                html = html.replace(/<br><li>/g, '<li>');
                // Remove <br> tags inside <ul> tags
                html = html.replace(/<ul><br>/g, '<ul>');
                html = html.replace(/<br><\/ul>/g, '</ul>');
                // Remove <br> tags right after </h> tags
                html = html.replace(/<\/h[1-6]><br>/g, (match) => match.replace('<br>', ''));
                
                return html;
            }
            
            // Add message to chat UI
            function addMessage(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${role}`;
                
                const label = document.createElement('div');
                label.className = 'message-label';
                label.textContent = role === 'user' ? 'You' : 'Assistant';
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                
                // For assistant messages, render markdown; for user messages, use plain text
                if (role === 'assistant') {
                    bubble.innerHTML = markdownToHtml(content);
                } else {
                    bubble.textContent = content;
                }
                
                messageDiv.appendChild(label);
                messageDiv.appendChild(bubble);
                chatMessages.appendChild(messageDiv);
                
                scrollChatToBottom();
            }
            
            // Show loading indicator
            function showLoading() {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'chat-loading';
                loadingDiv.id = 'chat-loading-indicator';
                loadingDiv.textContent = 'Thinking...';
                chatMessages.appendChild(loadingDiv);
                scrollChatToBottom();
            }
            
            // Remove loading indicator
            function hideLoading() {
                const loadingDiv = document.getElementById('chat-loading-indicator');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }
            
            // Show error message
            function showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'chat-error';
                errorDiv.textContent = message;
                chatMessages.appendChild(errorDiv);
                scrollChatToBottom();
            }
            
            // Send message to server
            async function sendMessage() {
                const message = chatInput.value.trim();
                
                if (!message) {
                    return;
                }
                
                // Add user message to UI
                addMessage('user', message);
                
                // Add to conversation history
                conversationHistory.push({
                    role: 'user',
                    content: message
                });
                
                // Clear input
                chatInput.value = '';
                
                // Disable input while processing
                chatInput.disabled = true;
                chatSendBtn.disabled = true;
                showLoading();
                
                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            history: conversationHistory
                        })
                    });
                    
                    hideLoading();
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to get response');
                    }
                    
                    const data = await response.json();
                    
                    // Add assistant response to UI
                    addMessage('assistant', data.response);
                    
                    // Add to conversation history
                    conversationHistory.push({
                        role: 'assistant',
                        content: data.response
                    });
                    
                } catch (error) {
                    hideLoading();
                    console.error('Chat error:', error);
                    showError(`Error: ${error.message}`);
                } finally {
                    // Re-enable input
                    chatInput.disabled = false;
                    chatSendBtn.disabled = false;
                    chatInput.focus();
                }
            }
            
            // Event listeners for chat
            chatSendBtn.addEventListener('click', sendMessage);
            
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Render markdown in initial message if it exists
            function renderInitialMessage() {
                const initialMessage = document.getElementById('initial-message');
                if (initialMessage) {
                    initialMessage.innerHTML = markdownToHtml(initialMessage.textContent);
                }
            }
            
            // Initialize: render initial message and scroll to bottom
            renderInitialMessage();
            scrollChatToBottom();
        </script>
        
        <div class="action-container">
            <a href="/" class="action-button">Analyze another target</a>
        </div>
    </body>
</html>